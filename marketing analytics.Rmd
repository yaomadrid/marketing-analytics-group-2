---
output:
  word_document: default
  pdf_document: default
  html_document: default
---
url: https://github.com/yaomadrid/marketing-analytics-group-2.git
title: "Marketing Analytics"
output: word_document
```{r}
library(readr)
ny_hmda <- read_csv("Data/ny_hmda_2015.csv")
library(dplyr)
library(ggplot2)
```
1. What is the data problem? What is the final managerial objective?

Our dataset covers all mortgage information in 2015 for the state of New York, provided by financial institutions. These information were required by Home Mortgage Disclosure Act (HMDA), which unveils all information of mortgage decisions and helps public to make loan decisions. Our final managerial objective is to find out the factors that influence the approval of mortgage and predict mortgage decision based on our model. 


2.Describe the measurement types of each variable

There are 78 variables in this original dataset, though there are some redundant variables which deliver the same information. We can classify these variables into applicants, loan, lender, property type, location.


3. Create a table summarizing the range or variation in each variable. Add statistics (mean,median, standard deviation, etc.) as you deem necessary.

We could first inspect the range or variation of each variable, leaving out character variables and we could know more about their features through descriptive statistics.

                                       
```{r}
summary(ny_hmda$applicant_income_000s)
summary(ny_hmda$hud_median_family_income)
summary(ny_hmda$loan_amount_000s)
summary(ny_hmda$number_of_1_to_4_family_units)
summary(ny_hmda$number_of_owner_occupied_units)
summary(ny_hmda$minority_population)
summary(ny_hmda$population)
summary(ny_hmda$rate_spread)
summary(ny_hmda$tract_to_msamd_income)
sd(ny_hmda$applicant_income_000s, na.rm = TRUE)
sd(ny_hmda$hud_median_family_income, na.rm = TRUE)
sd(ny_hmda$number_of_1_to_4_family_units, na.rm = TRUE)
sd(ny_hmda$number_of_owner_occupied_units, na.rm = TRUE)
sd(ny_hmda$population, na.rm = TRUE)
sd(ny_hmda$minority_population, na.rm = TRUE)
sd(ny_hmda$tract_to_msamd_income, na.rm = TRUE)

```


4. How do you handle missing data in this dataset?
```{r}
#Identify the number of missing value
summary(ny_hmda)
sum(is.na(ny_hmda$applicant_income_000s))
sum(is.na(ny_hmda$applicant_race_2))
sum(is.na(ny_hmda$applicant_race_3))
sum(is.na(ny_hmda$applicant_race_4))
sum(is.na(ny_hmda$applicant_race_5))
sum(is.na(ny_hmda$census_tract_number))
sum(is.na(ny_hmda$co_applicant_race_2))
sum(is.na(ny_hmda$co_applicant_race_3))
sum(is.na(ny_hmda$co_applicant_race_4))
sum(is.na(ny_hmda$co_applicant_race_5))
sum(is.na(ny_hmda$county_code))
sum(is.na(ny_hmda$denial_reason_1))
sum(is.na(ny_hmda$denial_reason_2))
sum(is.na(ny_hmda$denial_reason_3))
sum(is.na(ny_hmda$edit_status))
sum(is.na(ny_hmda$msamd))
sum(is.na(ny_hmda$hud_median_family_income))
sum(is.na(ny_hmda$number_of_1_to_4_family_units))
sum(is.na(ny_hmda$number_of_owner_occupied_units))
sum(is.na(ny_hmda$minority_population))
sum(is.na(ny_hmda$population))
sum(is.na(ny_hmda$rate_spread))
sum(is.na(ny_hmda$tract_to_msamd_income))


# deal with the missing of income _000$ #
library("dplyr")
ny_hmda <- ny_hmda %>%
filter(!is.na(applicant_income_000s)) 
ny_hmda$Income.Level = "0"
ny_hmda[ny_hmda$applicant_income_000s <= 60,]$Income.Level = "Level1"
ny_hmda[ny_hmda$applicant_income_000s > 60 & ny_hmda$applicant_income_000s <=90,]$Income.Level = "Level2"
ny_hmda[ny_hmda$applicant_income_000s > 90 & ny_hmda$applicant_income_000s <=150,]$Income.Level = "Level3"
ny_hmda[ny_hmda$applicant_income_000s > 150,]$Income.Level = "Level4"
table(ny_hmda$action_taken_name,ny_hmda$Income.Level)
nyTable<-table(ny_hmda$action_taken_name,ny_hmda$Income.Level)
chisq.test(nyTable)


Mode = function(x){
  ux = sort(unique(x))
  tabx = table(x)
  maxf = ux[which(tabx ==
                    max(tabx))]
  return(maxf)
}
Mode(ny_hmda$applicant_income_000s)
ny_hmda$applicant_income_000s[which(is.na(ny_hmda$applicant_income_000s))] <- 60
summary(ny_hmda$applicant_income_000s)

# deal with the missing of applicant_race_2,3,4,5, deleting the whole column#
ny_hmda[,c("applicant_race_2","applicant_race_3","applicant_race_4","applicant_race_5")]<-NULL
ny_hmda[,c("applicant_race_name_2","applicant_race_name_3","applicant_race_name_4","applicant_race_name_5")]<-NULL

# deal with the missing of co_applicant_race_2,3,4,5, deleting the whole column#
ny_hmda[,c("co_applicant_race_2","co_applicant_race_3","co_applicant_race_4","co_applicant_race_5")]<-NULL
ny_hmda[,c("co_applicant_race_name_2","co_applicant_race_name_3","co_applicant_race_name_4","co_applicant_race_name_5")]<-NULL

#deal with the missing of county_code
unique(ny_hmda$county_code)
unique(ny_hmda$county_name)
CountyTable<-table(ny_hmda$action_taken_name,ny_hmda$county_name)
chisq.test(CountyTable)
Mode(ny_hmda$county_code)
ny_hmda$county_code[which(is.na(ny_hmda$county_code))] <- 103
ny_hmda$county_name[which(is.na(ny_hmda$county_name))] <- "Suffolk County"

#deal with the missing of census_tract_number
chisq.test(table(ny_hmda$action_taken_name,ny_hmda$census_tract_number))
ny_hmda$census_tract_number[which(is.na(ny_hmda$census_tract_number))]<-Mode(ny_hmda$census_tract_number)
#deal with the missing of edit_status
chisq.test(table(ny_hmda$action_taken_name,ny_hmda$edit_status))
ny_hmda$edit_status[is.na(ny_hmda$edit_status)]="0"
ny_hmda$is_missing_editstatus<-"0"
ny_hmda$is_missing_editstatus[ny_hmda$edit_status==0]<-1

#deal with the missing of msamd
chisq.test(table(ny_hmda$action_taken_name,ny_hmda$msamd))
ny_hmda$msamd[is.na(ny_hmda$msamd)]="0"
ny_hmda$is_missing_msamd<-"0"
ny_hmda$is_missing_msamd[ny_hmda$msamd==0]<-1
#deal with the missing of hud_median_family_income

#deal with the missing of number_of_1_to_4_family_units
chisq.test(table(ny_hmda$action_taken_name,ny_hmda$number_of_1_to_4_family_units))
ny_hmda$number_of_1_to_4_family_units[which(is.na(ny_hmda$number_of_1_to_4_family_units))]<-Mode(ny_hmda$number_of_1_to_4_family_units)
#deal with the missing of number_of_owner_occupied_units
chisq.test(table(ny_hmda$action_taken_name,ny_hmda$number_of_owner_occupied_units))
ny_hmda$number_of_owner_occupied_units[which(is.na(ny_hmda$number_of_owner_occupied_units))]<-Mode(ny_hmda$number_of_owner_occupied_units)
#deal with the missing of minority_population
chisq.test(table(ny_hmda$action_taken_name,ny_hmda$minority_population))
ny_hmda$minority_population[which(is.na(ny_hmda$minority_population))]<-Mode(ny_hmda$minority_population)
#deal with the missing of population
ttest(table(ny_hmda$action_taken_name,ny_hmda$population))
ny_hmda$population[which(is.na(ny_hmda$population))]<-Mode(ny_hmda$population)
#deal with the missing of rate_spread
ny_hmda[,"rate_spread"]<-NULL
#deal with the missing of tract_to_msamd_income
chisq.test(table(ny_hmda$action_taken_name,ny_hmda$tract_to_msamd_income))
ny_hmda$population[which(is.na(ny_hmda$tract_to_msamd_income))]<-Mode(ny_hmda$tract_to_msamd_income)
```


There are 78 variables and 439654 observations in this dataset, however, a lot of variables contains a large number of missing data. There are basically two way to solve the missing data problem: delete the variables with missing data or mutate missing data into specific value. 

Since there are 439654 observations in total, we could directly delete those variables with more than 10 thousand missing values as they are less informative.  For those numeric variables, we could replace the missing value with the mean value of the variable. For those character variable, we could replace the missing value with the mode of the variable.

There is another problem about missing data in this specific dataset. Missing values in some variables are not labeled as "N/A" but as a specific number, such as "3". As for this problem, we could first filter the missing value then mutate it into a mean or mode of the variable.


5. Provide histograms/density plots for key variables, such as action taken on loan, gender, ethnicity, etc.

Action in Loans

```{r}
library(dplyr)
ny_hmda_possessed = ny_hmda %>%
group_by(action_taken_name) %>%
summarize(TotalActionTaken = n()) %>%
mutate(PercentageActionTaken = TotalActionTaken/sum(TotalActionTaken) * 100)
library(ggplot2)
ggplot(ny_hmda_possessed, aes(x = action_taken_name,y = PercentageActionTaken))+ geom_bar(stat='identity',colour="white")+labs( title = 'Actions in Loans')+theme(axis.text.x = element_text(angle = 30, hjust = 1))+geom_text(data=ny_hmda_possessed, aes(label=paste0(round(PercentageActionTaken,1),"%"), y=PercentageActionTaken+3), size=2) 
```

Histogram of Income
```{r}
library(dplyr)
ny_hmdaIncome <-ny_hmda %>%
  filter(!is.na(hud_median_family_income)) 
plot(density(ny_hmdaIncome$hud_median_family_income), main = "Histogram of income", 
    xlab = "Income", ylab = "density (#)")
```

Minority_population distribution
```{r}
library(dplyr)
ny_hm_minority_population <-ny_hmda %>%
  filter(!is.na(minority_population)) 
plot(density(ny_hm_minority_population$minority_population), main = "Minority_population", 
     xlab = "Minority", ylab = "Count (#)")

```


Actions in Loans by Gender
```{r}
ny_hmdaSex= ny_hmda %>%
  filter(applicant_sex < 3) %>%
  group_by(applicant_sex_name) %>%
  summarize(TotalActionTaken = n()) %>%
  mutate(PercentageActionTaken = TotalActionTaken/sum(TotalActionTaken) * 100)
library(ggplot2)
ggplot(ny_hmdaSex, aes(x = applicant_sex_name ,y = PercentageActionTaken))+ geom_bar(stat='identity',colour="red")+labs( title = 'Actions in Loans')



```

Action in Loans by Race
```{r}
ny_hmdaRace= ny_hmda %>%
  filter(applicant_race_1 < 7 )%>%
  group_by(applicant_race_name_1) %>%
  summarize(TotalActionTaken = n()) %>%
  mutate(PercentageActionTaken = TotalActionTaken/sum(TotalActionTaken) * 100)
ny_hmdaRace 
library(ggplot2)
ggplot(ny_hmdaRace, aes(x = applicant_race_name_1,(angle=30) ,y = PercentageActionTaken))+ geom_bar(stat='identity',colour="red")+labs( title = 'Actions in Loans by race')+theme(axis.text.x = element_text(angle = 30, hjust = 1))

```

Preapproval
```{r}
ny_hmda_preapproval= ny_hmda %>%
group_by(preapproval_name) %>%
summarize(TotalActionTaken = n()) %>%
mutate(PercentageActionTaken = TotalActionTaken/sum(TotalActionTaken) * 100)

ggplot(ny_hmda_preapproval, aes(x = preapproval_name,y = PercentageActionTaken))+ geom_bar(stat='identity',colour="blue")+labs(title = 'Percentage of Loans by Preapproval')+theme(axis.text.x = element_text(angle = 30, hjust = 1))
  

```


Owner Occupancy Graph
```{r}
ny_hmda_occupancy= ny_hmda %>%
    group_by(owner_occupancy_name) %>%
    summarize(TotalActionTaken = n()) %>%
    mutate(PercentageActionTaken = TotalActionTaken/sum(TotalActionTaken) * 100)
library(ggplot2)
ggplot(ny_hmda_occupancy, aes(x = owner_occupancy_name,(angle=30) ,y = PercentageActionTaken))+ geom_bar(stat='identity',colour="blue")+labs( title = 'Percentage of Loans by Owner Occupancy')+theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

Lien Status
```{r}
ny_hmda_lien = ny_hmda %>% 
  group_by(lien_status_name) %>%
  summarise(CountOfLien = n()) %>%
  arrange(desc(CountOfLien))
  ggplot(ny_hmda_lien, aes(x=lien_status_name, y=CountOfLien))+
    geom_bar(stat='identity',colour="grey")+labs(title = 'Loans by lien status')
           
```

loan purpose
```{r}
ny_hmda_loanPurpose = ny_hmda %>%
group_by(loan_purpose_name) %>%
summarize(TotalActionTaken = n()) %>%
arrange(desc(TotalActionTaken))
ggplot(ny_hmda_loanPurpose, aes(x = loan_purpose_name,y = TotalActionTaken))+ geom_bar(stat='identity',colour="blue")+labs(title = 'Loans by Purpose')
```


Loan Types
```{r}
ny_hmda_type= ny_hmda %>%
filter(!is.na(loan_type_name)) %>%
  group_by(loan_type_name) %>%
  summarize(TotalActionTaken = n()) %>%
  mutate(PercentageActionTaken = TotalActionTaken/sum(TotalActionTaken) * 100)
ggplot(ny_hmda_type, aes(x = loan_type_name,y = PercentageActionTaken))+ geom_bar(stat='identity',colour="blue")+labs( title = 'Percentage of Loans by Loan Types')+theme(axis.text.x = element_text(angle = 30, hjust = 1))

```


6. Create bivariate frequency distributions (tables or plots) for key variables. 

Lien_status distribution by actions

```{r}
# lien_status and action taken #
ny_hmda %>%
  filter(!is.na(lien_status)) %>%
  group_by(lien_status_name,action_taken_name) %>%
  summarise(CountActionTaken= n() ) %>%
  ggplot(aes(x = action_taken_name,y = CountActionTaken,fill =(lien_status_name))) +
  geom_bar(stat='identity',colour="white") +
  labs(x = 'action_taken', y = 'Count', title = 'Lien_status Distribution with Action Types') +
  theme_bw()+theme(axis.text.x = element_text(angle = 30, hjust = 1))


ny_hmdaLean_status=ny_hmda %>%
group_by(lien_status_name, action_taken_name) %>%
summarize(TotalActionTaken = n()) 
ny_hmdaLean_status
ggplot(ny_hmdaLean_status, aes(x = action_taken_name,y = TotalActionTaken))+ geom_bar(stat='identity',colour="red")+labs( title = 'lien_status distribution by actions')+facet_wrap(~ lien_status_name, scales ="free_y")+theme(axis.text.x = element_text(angle = 30, hjust = 1))

              
```

Loans Purpose Types Distribution with Race

```{r}
ny_hmdaRace_status=ny_hmda %>%
  filter(applicant_race_1 < 7 )%>%
  group_by(applicant_race_name_1, action_taken_name) %>%
  summarize(TotalActionTaken = n()) %>%
  mutate(PercentageActionTaken = TotalActionTaken /sum(TotalActionTaken)*100) 
ny_hmdaRace_status
ggplot(ny_hmdaRace_status, aes(x = action_taken_name,y = PercentageActionTaken),stat="count")+ geom_bar(stat='identity',colour="red")+labs( title = ' race destribution by loan actions')+ geom_bar(stat='identity',colour="red")+labs( title = ' Race and Loan Status')+facet_wrap(~ applicant_race_name_1 , scales ="free_y")+theme(axis.text.x = element_text(angle = 30, hjust = 1))+geom_text(data=ny_hmdaRace_status, aes(label=paste0(round(PercentageActionTaken,1),"%"),y=PercentageActionTaken+3), size=2)
                                                                                            
```

Loans Purpose Types Distribution with Action Types
```{r }
# ny_hmda_purpose and action taken #
ny_hmda_purpose <- ny_hmda %>%
group_by(loan_purpose_name,action_taken_name) %>%
summarize(TotalActionTaken = n()) %>%
mutate(PercentageActionTaken = TotalActionTaken /sum(TotalActionTaken)*100) 
ny_hmda_purpose
ggplot(ny_hmda_purpose,aes( x = action_taken_name,y = PercentageActionTaken),stat="count") +
geom_bar(stat='identity',colour="red") +
labs( title = 'Loans Purpose Types Distribution with Action Types') +
facet_wrap(~ loan_purpose_name , scales ="free_y")+theme(axis.text.x = element_text(angle = 30, hjust = 1))+geom_text(data=ny_hmda_purpose, aes(label=paste0(round(PercentageActionTaken,1),"%"), y=PercentageActionTaken+3), size=2)
  
```

Relationship between Applicant Income level and Action of Loans

```{r }
# income level and action taken #
ny_hmda_income =  ny_hmda %>%
filter(!is.na(applicant_income_000s)) 
ny_hmda_income$Income.Level = "0"
ny_hmda_income[ny_hmda_income$applicant_income_000s <= 60,]$Income.Level = "Level1"
ny_hmda_income[ny_hmda_income$applicant_income_000s > 60 & ny_hmda_income$applicant_income_000s <=90,]$Income.Level = "Level2"
ny_hmda_income[ny_hmda_income$applicant_income_000s > 90 & ny_hmda_income$applicant_income_000s <=150,]$Income.Level = "Level3"
ny_hmda_income[ny_hmda_income$applicant_income_000s > 150,]$Income.Level = "Level4"
Table <- table(ny_hmda_income$action_taken_name,ny_hmda_income$Income.Level)
Prop.Table <- prop.table(Table,2) 
round(Prop.Table,3)
```

#第六题#
```{r }


library(dplyr)
ny_hmApproval<-ny_hmda %>%
filter(action_taken <=3)  %>%
mutate(Loan_Approval = ifelse(action_taken==3, 0, 1))
ny_hmApproval
```


Loan_Approval is defined as a dummy variable. At first,  we selected obervations whose "action_taken_name" is either "loan originated","application is approved but not accepted", or "rejected by the institution", because we only care about whether the application is approved or not.

Then we assign "Loan_Approval=1" when "loan is originated" or "application is approved but not accepted" and assign "Loan_Approval= 0" when "application is denied”.

第七题 部分
we use Independent-Samples (or Unpaired Samples) t-test to compare the mean loan amounts between loans that were and were not approved.
##Null Hypothesis: Loan amounts Mean that were approved = Loan amounts Mean that were not approved 
##Alternate Hypothesis:Loan amounts Mean that were approved ! = Loan amounts Mean that were not approved

```{r }


t.test(ny_hmApproval[ny_hmApproval$Loan_Approval==1,]$loan_amount_000s,ny_hmApproval[ny_hmApproval$Loan_Approval == 0,]$loan_amount_000)
#According to the test result, the p-value is less than 5%#
#under 5% significant level, we can reject the null hypothesis and think that there is a significant difference between two means#a

# we use Independent-Samples t-test to compare the mean loan amounts #
t.test(ny_hmApproval[ny_hmApproval$applicant_income_000s<=83,]$Loan_Approval, ny_hmApproval[ny_hmApproval$applicant_income_000s>83,]$Loan_Approval)

```

The median of the income is 83, people whose income is below 83 are regarded as low income, above 83 is regarded as high income.

The Loan_Approval only has value 0 or 1, so the mean of Loan_Approval can represent the loan approval rate. According to the ttest, the P-value is less than 5%, so there is significant difference between the approval rate of two group.





